<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!-- 복사해서 사용 -->
<mapper namespace="member2Mapper">

    <!-- 공인중개사 승인 여부 -->
    <select id="selectAlarm" resultMap="memberMapper.alarm">
        SELECT ALARM_CODE
            , USER_NO
            , AUTHORITY_UPDATE
        FROM ALARM
        WHERE USER_NO = #{userNo}
    </select>

    <!-- 공인중개사 승인 요청 알림 -->
    <insert id="insertAlarm">
        MERGE
        INTO ALARM
        USING DUAL
        ON (USER_NO = #{userNo})
        WHEN MATCHED THEN
            UPDATE
            SET AUTHORITY_UPDATE = 2
        WHEN NOT MATCHED THEN
            INSERT (
                ALARM_CODE
                , USER_NO
                , AUTHORITY_UPDATE
            ) VALUES (
                (SELECT 'ALARM_'||LPAD(NVL(MAX(TO_NUMBER(SUBSTR(ALARM_CODE, 7))), 0) + 1, 3, '0') ALARM_CODE
                FROM ALARM)
                , #{userNo}
                , #{authorityUpdate}
            )
    </insert>

    <!-- 승인완료알림 -->
    <select id="selectAuthorityAlarm" resultType="int">
        SELECT AUTHORITY_UPDATE
        FROM ALARM
        WHERE USER_NO = #{userNo}
    </select>

    <!-- 문의 글 알림 -->
    <select id="selectInquiryAlarm" resultMap="realtorMapper.realtorDetail">
        SELECT REALTOR_CODE
            , TO_USER_NO
            , INQUIRY_CODE
            , INQUIRY_ANSWER
        FROM INQUIRY I , REALTOR_DETAIL R
        WHERE TO_USER_NO = #{toUserNo}
        AND I.TO_USER_NO = R.USER_NO
    </select>

    <!-- 문의 글 답글 완료 알림 -->
    <select id="selectUserInquiryAlarm" resultMap="roomMapper.inquiry">
        SELECT INQUIRY_CODE
            , ROOM_CODE
            , TO_USER_NO
            , FROM_USER_NO
            , I.INQUIRY_TITLE_CODE
            , INQUIRY_TITLES
            , INQUIRY_ANSWER
            , TO_CHAR(INQUIRY_DATE,'YYYY-MM-DD') INQUIRY_DATE
        FROM INQUIRY I, INQUIRY_TITLE T
        WHERE FROM_USER_NO = #{userNo}
        AND I.INQUIRY_TITLE_CODE = T.INQUIRY_TITLE_CODE
        ORDER BY INQUIRY_DATE DESC
    </select>
</mapper>































